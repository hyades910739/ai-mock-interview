<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock Interview Chatbot</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body.chat-mode {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
            background-color: #f0f2f5;
        }

        #chat-container {
            border: 1px solid #ddd;
            border-radius: 12px;
            /* height: 400px; */
            height: 65vh;
            overflow-y: auto;
            padding: 1rem;
            margin-bottom: 1rem;
            background: white;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .message {
            padding: 0.6rem 1rem;
            border-radius: 1rem;
            max-width: 80%;
            word-wrap: break-word;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .bot {
            background: #e4e6eb;
            color: #050505;
            align-self: flex-start;
            border-bottom-left-radius: 0.2rem;
        }

        .user {
            background: #0084ff;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0.2rem;
        }

        .ai-suggestion {
            background: #f3e5f5;
            color: #050505;
            align-self: flex-end;
            border-bottom-left-radius: 0.2rem;
            border: 1px solid #e1bee7;
        }

        .controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            align-items: center;
        }

        button {
            padding: 0.8rem 2rem;
            border-radius: 2rem;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.2s;
            user-select: none;
        }

        #record-btn {
            /* background: #ef9a9a; */
            background: #f65d5d;
            color: white;
            box-shadow: 0 2px 5px rgba(255, 59, 48, 0.3);
        }

        #record-btn:active {
            transform: scale(0.95);
        }

        #record-btn.recording {
            background: #ff3b30;
            animation: pulse 1.5s infinite;
        }

        button:disabled {
            background: #ccc !important;
            cursor: not-allowed;
            box-shadow: none !important;
        }

        .replay-btn {
            margin-left: 0.5rem;
            padding: 0.2rem 0.6rem;
            font-size: 0.8rem;
            background: #ddd;
            color: #333;
            border-radius: 4px;
            cursor: pointer;
            border: none;
        }

        #status {
            font-size: 0.8rem;
            color: #65676b;
            margin-top: 0.5rem;
            text-align: center;
        }

        .form-label,
        #btn_interview_preference {
            font-weight: bold;
            font-size: 1em;
            margin-top: 5px;

        }

        .form-text
        /* .form-check-label */

        /*, .form-check-input { */
            {
            font-size: 0.8em;
        }

        .form-check-input:checked {
            background-color: #198754;
            border-color: #198754;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.7;
                transform: scale(1.05);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .message-actions {
            align-self: flex-end;
            margin-top: -0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .message-actions button {
            padding: 0.2rem 0.6rem;
            font-size: 0.75rem;
            border-radius: 1rem;
            background-color: #f0f2f5;
            border: 1px solid #ddd;
            color: #555;
        }

        .message-actions button:hover {
            background-color: #e4e6eb;
        }

        .correct {
            font-size: 110%;
            font-weight: bold;
            color: #ff3b30;
        }

        .message-badge {
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 0.4rem;
            opacity: 0.8;
        }

        .message.user .message-badge {
            text-align: left;
            color: #ebebeb
        }

        .message.bot .message-badge,
        .message.ai-suggestion .message-badge {
            text-align: left;
        }

        .form-group {
            padding-bottom: 15px !important;
        }

        @media print {

            #setup-container,
            .controls,
            #status,
            .message-actions,
            .replay-btn {
                display: none !important;
            }

            body.chat-mode {
                background-color: white;
                margin: 0;
                padding: 0;
                max-width: 100%;
            }

            #chat-container {
                display: block !important;
                height: auto !important;
                overflow: visible !important;
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            .message {
                break-inside: avoid;
                border: 1px solid #eee;
                margin-bottom: 0.8rem;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .message.user,
            .message.ai-suggestion {
                margin-left: auto;
            }

            .message-badge {
                display: block !important;
                color: #555 !important;
            }
        }

        #interview-info {
            display: table;
            margin-left: auto;
            margin-right: auto;
            text-align: left;
            font-size: 0.8em;
        }


        .tooltip-inner {
            /* background-color: rgb(243, 156, 214); */
            background-color: #7dd9ae;
            max-width: 300px;
            /* opacity: 0.9 !important; */
        }

        .bs-tooltip-top .tooltip-arrow::before,
        .bs-tooltip-auto[data-popper-placement^=top] .tooltip-arrow::before {
            border-top-color: #7dd9ae !important;
            /* opacity: 0.9; */
        }

        #setup-title {
            color: #198754;
            padding-bottom: 3px;
            /* border-bottom: 1px solid #333; */
            /* background-color: #198754; */
        }

        /* .tooltip-arrow {
            position: absolute;
            width: 0;
            height: 0
        } */

        /* .custom-colored-tooltip {
            --bs-tooltip-bg: rgb(243, 156, 214);

        }

        .custom-colored-tooltip .tooltip-arrow::before {
            border-top-color: rgb(243, 156, 214) !important;
            border-right-color: rgb(243, 156, 214) !important;
            border-bottom-color: rgb(243, 156, 214) !important;
            border-left-color: rgb(243, 156, 214) !important;
        } */
    </style>
</head>

<body class="bg-light">
    <!-- Setup Interface -->
    <div id="setup-container" class="container py-5" style="max-width: 750px;">
        <div class="card shadow-sm">
            <!-- <div class="card-header" style="background-color: #198754;">
                Interview Setup
            </div> -->
            <div class="card-body p-4">

                <h2 class="text-center mb-4" id="setup-title">
                    <i class="bi bi-gear-fill"></i>
                    Interview Setup
                </h2>
                <form id="setup-form">
                    <!-- 1. Name -->
                    <div class="mb-3 form-group">
                        <label for="userName" class="form-label">Your Name</label>
                        <input type="text" class="form-control" id="userName" required>
                    </div>

                    <!-- 2. Position -->
                    <div class="mb-3 form-group">
                        <label for="userPosition" class="form-label">Position</label>
                        <input type="text" class="form-control" id="userPosition" value="Machine Learning Engineer">
                    </div>
                    <!-- 3. Years of experimence -->
                    <div class="mb-3 form-group">
                        <label for="yearsOfExperience" class="form-label">Years of Experience (Y)</label>
                        <input type="number" min="0" max="40" step="0.1" class="form-control" id="yearsOfExperience"
                            value="5">
                    </div>

                    <!-- 4. Interview Type -->
                    <div class="mb-3 form-group">
                        <label class="form-label d-block">Interview Type</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="interviewType" id="typeTechnical"
                                value="Technical" autocomplete="off" checked>
                            <label class="btn btn-outline-success" for="typeTechnical" data-toggle="tooltip"
                                data-placement="top"
                                title="Focus on technical questions and your previous project experience.">
                                <i class="bi bi-code-slash me-2"></i>Technical
                            </label>
                            <input type="radio" class="btn-check" name="interviewType" id="typeBehavioral"
                                value="Behavioral" autocomplete="off">
                            <label class="btn btn-outline-success" for="typeBehavioral" data-toggle="tooltip"
                                data-placement="top"
                                title="Focus on behavioral questions to evaluate whether you are easy to work with.">
                                <i class="bi bi-chat-quote-fill me-2"></i>Behavioral
                            </label>


                        </div>
                    </div>

                    <!-- 5. OpenAI API Key -->
                    <div class="mb-3 form-group">
                        <label for="apiKey" class="form-label">OpenAI API Key</label>
                        <input type="password" class="form-control" id="apiKey" placeholder="sk-...">
                        <div class="form-text">
                            Set up API Key to use OpenAI's ChatGPT, TTS, STT function.<br>
                            You can skip this if you already set API Key as environment variable when lauching
                            this app.
                        </div>
                    </div>

                    <!-- 6. Upload CV -->
                    <div class="mb-3 form-group">
                        <label for="cvUpload" class="form-label">Upload CV (Optional, PDF file only.)</label>
                        <input class="form-control" type="file" id="cvUpload" accept=".pdf">
                        <div class="form-text">
                            By uploading your CV, the interviewer can ask questions based on your experience.
                        </div>

                    </div>

                    <!-- 7. Interview Preference -->
                    <div class="mb-3 form-group">
                        <!-- btn btn-outline-success p-0 text-decoration-none  -->
                        <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse"
                            data-bs-target="#preferenceCollapse" id="btn_interview_preference">
                            <i class="bi bi-gear-fill me-1"></i> Interview Preference
                        </button>
                        <div class="collapse mt-2 show" id="preferenceCollapse">
                            <div class="card card-body bg-light border-0">
                                <div class="mb-3">
                                    <label class="form-label d-block">Interviewer Personality</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="interviewerPersonality"
                                            id="personalityFriendly" value="friendly" autocomplete="off" checked>
                                        <label class="btn btn-outline-success" for="personalityFriendly">
                                            <i class="bi bi-emoji-smile me-2"></i>Friendly
                                        </label>
                                        <input type="radio" class="btn-check" name="interviewerPersonality"
                                            id="personalityStrict" value="strict" autocomplete="off">
                                        <label class="btn btn-outline-danger" for="personalityStrict">
                                            <i class="bi bi-emoji-angry me-2"></i>Strict
                                        </label>
                                    </div>
                                </div>
                                <!-- <div class="form-check mb-3"> -->
                                <div class="mb-3">
                                    <label class="form-label d-block">Voice</label>
                                    <input class="form-check-input" type="checkbox" id="enableVoice" checked>
                                    <label class="form-check-label" for="enableVoice">
                                        Enable interviewers' voice <small class="text-muted">(Enable voice cause
                                            additional API cost)</small>
                                    </label>
                                </div>
                                <!-- deprecated -->
                                <!-- <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="enableAdvice" checked>
                                            <label class="form-check-label" for="enableAdvice">
                                                Enable Answer Advice <small class="text-muted">(Enable a coach that
                                                    generates
                                                    modified answers)</small>
                                            </label>
                                        </div> -->
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" id="start-interview-btn" class="btn btn-success btn-lg">Start
                            Interview</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Chat Interface (Initially Hidden) -->
    <div id="chat-interface" class="d-none">
        <h2 style="text-align: center; color: #333;" class="mt-4" id="chat-interface-title">Mock Interview</h2>
        <div id="interview-info" class="mb-3 text-secondary"></div>
        <div id="chat-container"></div>
        <div class="controls">
            <button id="record-btn">Record Answer</button>
        </div>
        <div class="controls" style="margin-top: 10px;">
            <button id="end-btn" style="background-color: #546a7d; color: white;">Exit</button>
            <button id="save-btn" style="background-color: #1c6c46; color: white;">Save</button>
            <button id="diagnosis-btn" style="background-color: #1c6c46; color: white;">Diagnosis and Exit</button>
        </div>
        <div id="status">Ready to record</div>
    </div>
    <!-- Diagnosis Interface (Initially Hidden) -->
    <div id="diagnosis-interface" class="d-none">
        <h2 style="text-align: center; color: #333;" class="mt-4">Interview Diagnosis</h2>
        <div id="diagnosis-content" class="card card-body"
            style="max-width: 800px; margin: 1rem auto; background-color: #fff; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
        </div>
    </div>
    <!-- Jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <!-- Bootstrap JS -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js"
        integrity="sha384-G/EV+4j2dNv+tEPo3++6LCgdCROaejBqfUeNjuKAiuXbjrxilcCdDz6ZAVfHWe1Y"
        crossorigin="anonymous"></script>
    <script>
        const chatContainer = document.getElementById('chat-container');
        const recordBtn = document.getElementById('record-btn');
        const statusDiv = document.getElementById('status');
        let sessionId = null;
        let ws;
        let mediaRecorder;
        let audioChunks = [];
        let currentTranscribingMessage = null;
        let heartbeatInterval;

        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })

        // é¡¯ç¤ºè¨Šæ¯åŠŸèƒ½
        function appendMessage(text, sender, index) {
            const div = document.createElement('div');
            div.classList.add('message', sender);
            if (index !== undefined && index !== null) {
                div.dataset.index = index;
            }

            if (index !== undefined && index !== null) {
                let badgeText = "";
                if (sender === 'bot') badgeText = `Q${index} - Interviewer`;
                else if (sender === 'user') badgeText = `Q${index} - Interviewee`;

                if (badgeText) {
                    const badge = document.createElement('div');
                    badge.className = 'message-badge';
                    badge.textContent = badgeText;
                    div.appendChild(badge);
                }
            }

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = text;
            div.appendChild(contentDiv);

            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            if (sender === 'user' && index !== undefined && index !== null) {
                addMessageControls(div, index);
            }
            return div;
        }

        // 0. è¨­å®šè¡¨å–®è™•ç†
        document.getElementById('setup-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const startBtn = document.getElementById('start-interview-btn');
            const originalText = startBtn.innerHTML;
            startBtn.disabled = true;
            startBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';

            const formData = new FormData();
            formData.append('name', document.getElementById('userName').value);
            formData.append('position', document.getElementById('userPosition').value);
            formData.append('years_of_experience', document.getElementById('yearsOfExperience').value);
            formData.append('interview_type', document.querySelector('input[name="interviewType"]:checked').value);
            formData.append('interviewer_personality', document.querySelector('input[name="interviewerPersonality"]:checked').value);
            formData.append('openai_api_key', document.getElementById('apiKey').value);
            formData.append('enable_voice', document.getElementById('enableVoice').checked);
            // formData.append('enable_advice', document.getElementById('enableAdvice').checked);

            const cvFile = document.getElementById('cvUpload').files[0];
            if (cvFile) {
                formData.append('cv', cvFile);
            }

            try {
                const response = await fetch('/setup', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    sessionId = data.session_id;

                    // Update interview info
                    const name = document.getElementById('userName').value;
                    const position = document.getElementById('userPosition').value;
                    const now = new Date();
                    const timeStr = `${now.getFullYear()}/${String(now.getMonth() + 1).padStart(2, '0')}/${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;

                    document.getElementById('interview-info').innerHTML = `
                        <div>Time: ${timeStr}</div>
                        <div>Name: ${name}</div>
                        <div>Position: ${position}</div>
                    `;

                    const interviewType = document.querySelector('input[name="interviewType"]:checked').value;
                    document.getElementById('chat-interface-title').textContent = `Mock Interview - ${interviewType}`;

                    // åˆ‡æ›ä»‹é¢
                    document.getElementById('setup-container').classList.add('d-none');
                    document.getElementById('chat-interface').classList.remove('d-none');
                    document.body.classList.remove('bg-light');
                    document.body.classList.add('chat-mode');
                    recordBtn.disabled = true;
                    document.getElementById('save-btn').disabled = true;
                    document.getElementById('diagnosis-btn').disabled = true;

                    // Reset button state for when user returns to setup
                    startBtn.disabled = false;
                    startBtn.innerHTML = originalText;

                    // åˆå§‹åŒ– WebSocket
                    connectWebSocket();
                    // appendMessage("ä½ å¥½ï¼Œå¾ˆé«˜èˆˆèªè­˜ä½ ", "bot");
                } else {
                    const errorData = await response.json();
                    alert(errorData.detail || 'Setup failed. Please check your inputs.');
                    startBtn.disabled = false;
                    startBtn.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred during setup.');
                startBtn.disabled = false;
                startBtn.innerHTML = originalText;
            }
        });

        // 2. å»ºç«‹ WebSocket é€£ç·š
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws?session_id=${sessionId}`);
            ws.binaryType = 'arraybuffer'; // è¨­å®šæŽ¥æ”¶äºŒé€²ä½è³‡æ–™

            ws.onopen = () => {
                console.log('Connected to WebSocket');
                statusDiv.textContent = "Connected to WebSocket";
                // Start sending heartbeats
                heartbeatInterval = setInterval(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        console.log("Sending ping");
                        ws.send(JSON.stringify({ type: 'ping' }));
                    }
                }, 30000); // Send a ping every 30 seconds
            };

            ws.onclose = () => {
                console.log('Disconnected');
                statusDiv.textContent = "Disconnected";
                // Stop sending heartbeats
                clearInterval(heartbeatInterval);
            };

            ws.onmessage = (event) => {
                if (typeof event.data === 'string') {
                    if (event.data === 'pong') {
                        console.log('pong');
                        return;
                    }
                    handleTextMessage(event.data);
                } else {
                    handleBinaryMessage(event.data);
                }
            };
        }

        function createLoadingMessage(index, type) {
            const div = document.createElement('div');
            div.classList.add('message', 'ai-suggestion');
            div.dataset.relatedIndex = index;
            div.dataset.type = type;

            let badgeText = "";
            if (type === "grammar_check") badgeText = `Q${index} - Grammar Check`;
            else if (type === "generate_ai_answer") badgeText = `Q${index} - AI Answer`;

            div.innerHTML = `
                <div class="message-badge">${badgeText}</div>
                <div class="message-content">
                    <div class="d-flex align-items-center gap-2">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                        <span class="text-secondary">Generating answer...</span>
                    </div>
                </div>
            `;

            const messageDiv = document.querySelector(`.message.user[data-index="${index}"]`);
            if (messageDiv) {
                let insertAfterNode = messageDiv;
                // If the next element is message-actions, insert after that
                if (messageDiv.nextElementSibling && messageDiv.nextElementSibling.classList.contains('message-actions')) {
                    insertAfterNode = messageDiv.nextElementSibling;
                }

                if (insertAfterNode.nextSibling) {
                    chatContainer.insertBefore(div, insertAfterNode.nextSibling);
                } else {
                    chatContainer.appendChild(div);
                }
            } else {
                chatContainer.appendChild(div);
            }
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addMessageControls(messageDiv, index) {
            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'message-actions';

            // Grammar Check Button
            const grammarBtn = document.createElement('button');
            grammarBtn.innerHTML = '<i class="bi bi-spellcheck"></i> Correct Grammar';
            grammarBtn.onclick = () => {
                const contentDiv = messageDiv.querySelector('.message-content');
                const text = contentDiv ? contentDiv.textContent : messageDiv.textContent;
                if (ws && ws.readyState === WebSocket.OPEN) {
                    createLoadingMessage(index, "grammar_check");
                    ws.send(JSON.stringify({
                        type: "grammar_check",
                        data: { user: text, index: index }
                    }));
                }
            };

            // AI Answer Button
            const aiBtn = document.createElement('button');
            aiBtn.innerHTML = '<i class="bi bi-magic"></i> See AI Answer';
            aiBtn.onclick = () => {
                const contentDiv = messageDiv.querySelector('.message-content');
                const text = contentDiv ? contentDiv.textContent : messageDiv.textContent;
                const botMsg = document.querySelector(`.message.bot[data-index="${index}"]`);
                const botContentDiv = botMsg ? botMsg.querySelector('.message-content') : null;
                const botText = botContentDiv ? botContentDiv.textContent : (botMsg ? botMsg.textContent : "");

                if (ws && ws.readyState === WebSocket.OPEN) {
                    createLoadingMessage(index, "generate_ai_answer");
                    ws.send(JSON.stringify({
                        type: "generate_ai_answer",
                        data: {
                            interviewer: botText,
                            user: text,
                            index: index,
                        }
                    }));
                }
            };

            controlsDiv.appendChild(grammarBtn);
            controlsDiv.appendChild(aiBtn);

            if (messageDiv.nextSibling) {
                chatContainer.insertBefore(controlsDiv, messageDiv.nextSibling);
            } else {
                chatContainer.appendChild(controlsDiv);
            }
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function createTranscribingMessage() {
            const div = document.createElement('div');
            div.classList.add('message', 'user');
            div.innerHTML = `
                <div class="message-content">
                    <div class="d-flex align-items-center gap-2">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <span>Converting to text...</span>
                    </div>
                </div>
            `;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return div;
        }

        function handleTextMessage(text) {
            if (text === "START_AUDIO") {
                initAudioStream();
                return;
            }
            if (text === "END_AUDIO") {
                finalizeAudioStream();
                return;
            }

            try {
                const data = JSON.parse(text);
                if (data.type === "user") {
                    if (currentTranscribingMessage) {
                        currentTranscribingMessage.innerHTML = '';

                        const badge = document.createElement('div');
                        badge.className = 'message-badge';
                        badge.textContent = `Q${data.index} - Interviewee`;
                        currentTranscribingMessage.appendChild(badge);

                        const content = document.createElement('div');
                        content.className = 'message-content';
                        content.textContent = data.content;
                        currentTranscribingMessage.appendChild(content);

                        currentTranscribingMessage.dataset.index = data.index;
                        addMessageControls(currentTranscribingMessage, data.index);
                        currentTranscribingMessage = null;
                    } else {
                        appendMessage(data.content, "user", data.index);
                    }
                } else if (data.type === "interviewer") {
                    appendMessage(data.content, "bot", data.index);
                    recordBtn.disabled = false;
                    if (data.index >= 2) {
                        document.getElementById('save-btn').disabled = false;
                        document.getElementById('diagnosis-btn').disabled = false;
                    }
                } else if (data.type === "grammar_check" || data.type === "generate_ai_answer") {
                    const loadingMsg = document.querySelector(`.message.ai-suggestion[data-related-index="${data.index}"][data-type="${data.type}"]`);
                    if (loadingMsg) {
                        const contentDiv = loadingMsg.querySelector('.message-content');
                        if (contentDiv) {
                            contentDiv.innerHTML = data.content;
                        }
                        loadingMsg.removeAttribute('data-type');
                    }
                }
            } catch (e) {
                console.error("Error parsing message:", e);
            }
        }

        function handleBinaryMessage(data) {
            // 1. å­˜èµ·ä¾†ä¾›é‡æ’­ä½¿ç”¨
            receivedAudioChunks.push(data);

            // 2. ä¸²æµæ’­æ”¾é‚è¼¯
            if (sourceBuffer && !sourceBuffer.error) {
                audioQueue.push(data);
                processQueue();
            }
        }

        // åˆå§‹åŒ– MediaSource é€²è¡Œä¸²æµæ’­æ”¾
        function initAudioStream() {
            receivedAudioChunks = [];
            audioQueue = [];
            isUpdating = false;

            const audio = new Audio();
            mediaSource = new MediaSource();
            audio.src = URL.createObjectURL(mediaSource);
            audio.play().catch(e => console.log("Autoplay prevented:", e));

            mediaSource.addEventListener('sourceopen', () => {
                // å»ºç«‹ SourceBufferï¼Œè¨­å®šç‚º MP3 æ ¼å¼
                sourceBuffer = mediaSource.addSourceBuffer('audio/mpeg');
                sourceBuffer.addEventListener('updateend', () => {
                    isUpdating = false;
                    processQueue();
                });
            });
        }

        // è™•ç†éŸ³è¨Šä½‡åˆ— (é¿å… SourceBuffer å¿™ç¢Œæ™‚å¯«å…¥)
        function processQueue() {
            if (audioQueue.length > 0 && !isUpdating && sourceBuffer && !sourceBuffer.updating) {
                try {
                    const chunk = audioQueue.shift();
                    sourceBuffer.appendBuffer(chunk);
                    isUpdating = true;
                } catch (e) {
                    console.error("SourceBuffer error:", e);
                }
            }
        }

        // çµæŸä¸²æµä¸¦æ–°å¢žé‡æ’­æŒ‰éˆ•
        function finalizeAudioStream() {
            if (mediaSource && mediaSource.readyState === 'open') {
                mediaSource.endOfStream();
            }

            // å»ºç«‹å®Œæ•´çš„ Blob ä¾›é‡æ’­
            const fullBlob = new Blob(receivedAudioChunks, { type: 'audio/mpeg' });
            const audioUrl = URL.createObjectURL(fullBlob);

            // æ‰¾åˆ°æœ€å¾Œä¸€å€‹æ©Ÿå™¨äººè¨Šæ¯ï¼ŒåŠ ä¸Šæ’­æ”¾æŒ‰éˆ•
            const messages = document.querySelectorAll('.message.bot');
            const lastMsg = messages[messages.length - 1];
            if (lastMsg) {
                const btn = document.createElement('button');
                btn.textContent = "ðŸ”Š Replay audio";
                btn.className = "replay-btn";
                btn.onclick = () => {
                    const audio = new Audio(audioUrl);
                    audio.play();
                };
                lastMsg.appendChild(btn);
            }
        }

        // 3. è¨­å®šéŒ„éŸ³åŠŸèƒ½
        async function setupRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                statusDiv.textContent = "Ready to record";

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    if (!sessionId) {
                        audioChunks = [];
                        return;
                    }
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = () => {
                        const base64data = reader.result.split(',')[1];
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({ type: "audio", data: base64data }));
                            currentTranscribingMessage = createTranscribingMessage();
                        } else {
                            alert("Unable to send message: websocket not connected.");
                        }
                    };
                    audioChunks = [];
                };
            } catch (err) {
                console.error("Microphone access denied:", err);
                statusDiv.textContent = "Error: ubable to access microphone.";
            }
        }

        setupRecording();

        // 4. æŒ‰éˆ•äº’å‹•é‚è¼¯ (é»žæ“Šåˆ‡æ›)
        const toggleRecording = async () => {
            console.log("recording toggled.")
            if (!mediaRecorder) {
                console.log("no media recorder. trying to setup")
                await setupRecording();
                if (!mediaRecorder) {
                    alert("Please allow microphone access.");
                    return;
                }
            }

            if (mediaRecorder.state === 'inactive') {
                mediaRecorder.start();
                recordBtn.textContent = "Recording...";
                recordBtn.classList.add('recording');
            } else if (mediaRecorder.state === 'recording') {
                console.log("recording.")
                mediaRecorder.stop();
                recordBtn.textContent = "Record Answer";
                recordBtn.classList.remove('recording');
                recordBtn.disabled = true;
            }
        };

        recordBtn.addEventListener('click', toggleRecording);

        // 5. çµæŸæœƒè©±åŠŸèƒ½
        document.getElementById('end-btn').addEventListener('click', () => {
            endSession();
        });

        document.getElementById('save-btn').addEventListener('click', () => {
            window.print();
            // endSession();
        });

        document.getElementById('diagnosis-btn').addEventListener('click', async () => {
            const diagnosisBtn = document.getElementById('diagnosis-btn');
            diagnosisBtn.disabled = true;
            diagnosisBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Diagnosing...';

            try {
                const response = await fetch('/diagnosis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ session_id: sessionId })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('chat-interface').classList.add('d-none');
                    document.getElementById('status').classList.add('d-none');
                    document.getElementById('diagnosis-interface').classList.remove('d-none');

                    const diagnosisContent = document.getElementById('diagnosis-content');
                    diagnosisContent.innerHTML = `
                        <h5>Score: ${data.score}</h5>
                        <p><strong>The chances of getting this job:</strong> ${(data['the_chances_of_getting_this_job']).toFixed(1)}%</p>
                        <p><strong>Comments:</strong><br> ${data.comments}</p>
                        <p><strong>What to improve:</strong><br> ${data['what_to_improve']}</p>
                        <div class="text-center mt-4">
                            <button id="new-interview-btn" class="btn btn-primary">Start a New Interview</button>
                        </div>
                    `;
                    document.getElementById('new-interview-btn').addEventListener('click', endSession);
                    if (ws) {
                        ws.close();
                    }

                } else {
                    alert('Failed to get diagnosis.');
                    diagnosisBtn.disabled = false;
                    diagnosisBtn.innerHTML = 'Diagnosis';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while getting the diagnosis.');
                diagnosisBtn.disabled = false;
                diagnosisBtn.innerHTML = 'Diagnosis';
            }
        });

        function endSession() {
            sessionId = null;
            currentTranscribingMessage = null;
            if (ws) ws.close();
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                recordBtn.textContent = "Record Answer";
                recordBtn.classList.remove('recording');
            }

            document.getElementById('chat-interface').classList.add('d-none');
            document.getElementById('diagnosis-interface').classList.add('d-none');
            document.getElementById('setup-container').classList.remove('d-none');
            document.body.classList.remove('chat-mode');
            document.body.classList.add('bg-light');
            chatContainer.innerHTML = '';
            statusDiv.textContent = "Ready to record";
            statusDiv.classList.remove('d-none');
        }
    </script>
</body>

</html>